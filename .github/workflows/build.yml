name: Build

on:
  pull_request:
    types:
      - edited
      - opened
      - ready_for_review
      - synchronize

  push:
    branches:
      - main
    paths:
      - go.mod
      - go.sum
      - "**/*.go"
      - Dockerfile
      - .github/workflows/build.yml
  merge_group:
  workflow_call:
    inputs:
      tag:
        type: string
        required: true

jobs:
  build-multiarch:
    permissions:
      contents: read
      id-token: write
    uses: grafana/shared-workflows/.github/workflows/docker-build-push-multiarch.yml@f24f3b13b6eb4a2bef9933f31b8a9f1799e13b8b # main
    with:
      platforms: linux/amd64,linux/arm64
      tags: |
        type=ref,event=branch,enable={{is_default_branch}}
        type=semver,pattern={{version}},value=${{ inputs.tag }},enable=${{ inputs.tag != '' }}
      push: ${{ github.event_name == 'push' || github.event_name == 'workflow_call' }}
      registries: dockerhub
      runner-type: github
